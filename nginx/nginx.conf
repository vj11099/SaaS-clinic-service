upstream django {
    # "django" is the service name in docker-compose.yml
    # Docker resolves this to the Django container's IP automatically
    server django:8000;
}

server {
    listen 80;
    server_name localhost;

    # ── Static files ───────────────────────────────────────────────────────
    # Nginx serves these directly — Django and Gunicorn never see these requests
    # The path matches the static_files volume mounted in docker-compose.yml
    location /static/ {
        alias /app/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # ── API and app requests ───────────────────────────────────────────────
    # Everything else gets forwarded to Gunicorn
    location / {
        proxy_pass http://django;

        # Pass the real client IP to Django
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Pass the original host header so Django knows what domain was requested
        proxy_set_header Host $host;

        # Tell Django the request came through a proxy
        proxy_set_header X-Real-IP $remote_addr;

        # Disable automatic redirects — let Django handle them
        proxy_redirect off;

        # Timeouts — should match or exceed Gunicorn's --timeout value
        proxy_connect_timeout 120s;
        proxy_read_timeout    120s;
        proxy_send_timeout    120s;

        # Buffer settings — Nginx buffers the response from Gunicorn
        # so slow clients don't hold up Gunicorn workers
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 8 8k;
    }

    # ── Client request size ────────────────────────────────────────────────
    # Increase if you accept file uploads — default is 1MB which is very low
    client_max_body_size 20M;
}
